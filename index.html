<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Browser Info</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .block { background: #f2f2f2; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>

<h1>Информация о браузере</h1>

<div class="block">
    <h2>Основная информация</h2>
    <p><b>User-Agent:</b> <span id="ua">Загрузка...</span></p>
    <p><b>Язык:</b> <span id="lang">Загрузка...</span></p>
    <p><b>Платформа:</b> <span id="platform">Загрузка...</span></p>
    <p><b>Timezone:</b> <span id="tz">Загрузка...</span></p>
    <p><b>Разрешение экрана:</b> <span id="screen">Загрузка...</span></p>
    <p><b>navigator.webdriver:</b> <span id="webdriver">Загрузка...</span></p>
</div>

<div class="block">
    <h2>Информация о GPU (WebGL)</h2>
    <p><b>Vendor:</b> <span id="gpuVendor">Загрузка...</span></p>
    <p><b>Renderer:</b> <span id="gpuRenderer">Загрузка...</span></p>
</div>

<div class="block">
    <h2>Сеть (Network Information API)</h2>
    <p><b>Тип соединения:</b> <span id="connectionType">Загрузка...</span></p>
    <p><b>Effective Type:</b> <span id="effectiveType">Загрузка...</span></p>
    <p><b>Скорость (downlink):</b> <span id="downlink">Загрузка...</span></p>
    <p><b>RTT:</b> <span id="rtt">Загрузка...</span></p>
</div>

<div class="block">
    <h2>Локальный IP (через WebRTC)</h2>
    <p><b>IP:</b> <span id="ip">Загрузка...</span></p>
</div>

<script>
async function collectAndSendData() {
    const info = {};

    // Основная информация
    info.userAgent = navigator.userAgent;
    info.webdriver = navigator.webdriver || false;
    info.language = navigator.language;
    info.platform = navigator.platform;
    info.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    info.screen = `${screen.width}x${screen.height} (viewport: ${window.innerWidth}x${window.innerHeight})`;

    document.getElementById('ua').textContent = info.userAgent;
    document.getElementById('lang').textContent = info.language;
    document.getElementById('platform').textContent = info.platform;
    document.getElementById('tz').textContent = info.timezone;
    document.getElementById('screen').textContent = info.screen;
    document.getElementById('webdriver').textContent = info.webdriver;

    // WebGL
    const canvas = document.createElement("canvas");
    const gl = canvas.getContext("webgl");
    let gpuInfo = { vendor: "Не доступно", renderer: "Не доступно" };
    if (gl) {
        const dbg = gl.getExtension("WEBGL_debug_renderer_info");
        if (dbg) {
            gpuInfo.vendor = gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL);
            gpuInfo.renderer = gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL);
        } else {
            gpuInfo.vendor = gl.getParameter(gl.VENDOR);
            gpuInfo.renderer = gl.getParameter(gl.RENDERER);
        }
    }
    info.gpuVendor = gpuInfo.vendor;
    info.gpuRenderer = gpuInfo.renderer;
    document.getElementById('gpuVendor').textContent = gpuInfo.vendor;
    document.getElementById('gpuRenderer').textContent = gpuInfo.renderer;

    // Network
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection || {};
    info.connectionType = connection.type || "Неизвестно";
    info.effectiveType = connection.effectiveType || "Неизвестно";
    info.downlink = connection.downlink || "Неизвестно";
    info.rtt = connection.rtt || "Неизвестно";

    document.getElementById('connectionType').textContent = info.connectionType;
    document.getElementById('effectiveType').textContent = info.effectiveType;
    document.getElementById('downlink').textContent = info.downlink;
    document.getElementById('rtt').textContent = info.rtt;

    // Local IP через WebRTC
    function getLocalIP() {
        return new Promise((resolve) => {
            const pc = new RTCPeerConnection({iceServers:[]});
            pc.createDataChannel("");
            pc.createOffer().then(sdp => pc.setLocalDescription(sdp));
            pc.onicecandidate = (event) => {
                if (!event.candidate) return;
                const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
                const ipMatch = ipRegex.exec(event.candidate.candidate);
                if (ipMatch) {
                    resolve(ipMatch[1]);
                    pc.onicecandidate = null;
                }
            };
            setTimeout(() => resolve("Не удалось получить"), 2000);
        });
    }

    info.localIP = await getLocalIP();
    document.getElementById('ip').textContent = info.localIP;

    // Вывод в консоль
    console.log("Collected Client Info:", info);

    // Отправка на сервер
    try {
        await fetch("http://localhost:5000/collect", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(info)
        });
        console.log("Data sent to server!");
    } catch(e) {
        console.warn("Не удалось отправить данные:", e);
    }
}

// Запуск при каждой загрузке
window.addEventListener("load", collectAndSendData);
</script>

</body>
</html>
